<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>P2P Profit Binance</title>
  <style>
    :root {
      --bg-color: #f5f7fa;
      --text-color: #222;
      --primary-color: #1a73e8;
      --secondary-color: #555;
      --accent-color: #e8f0fe;
      --button-bg: #1a73e8;
      --button-text: #fff;
      --input-bg: #fff;
      --input-border: #ccc;
      --table-bg: #fff;
      --table-header-bg: #eaeaea;
      --table-border: #ddd;
    }

    body.dark {
      --bg-color: #121315;
      --text-color: #d6b900;
      --primary-color: #f3ba2f;
      --secondary-color: #ccc;
      --accent-color: #2a2b2f;
      --button-bg: #d6b900;
      --button-text: #121315;
      --input-bg: #1e1f22;
      --input-border: #444548;
      --table-bg: #2a2b2f;
      --table-header-bg: #3e3f43;
      --table-border: #444548;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      transition: background-color 0.4s, color 0.4s;
    }

    header {
      width: 100%;
      max-width: 720px;
      padding: 1.2rem 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--accent-color);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border-radius: 0 0 12px 12px;
      transition: background 0.4s;
    }

    header h2 {
      margin: 0;
      font-weight: 700;
      font-size: 1.8rem;
      color: var(--primary-color);
      user-select: none;
    }

    .theme-toggle-btn {
      background: var(--button-bg);
      border: none;
      padding: 8px 14px;
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
      color: var(--button-text);
      transition: background-color 0.3s;
      user-select: none;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    .theme-toggle-btn:hover { background: var(--primary-color); }

    main {
      width: 95%;
      max-width: 720px;
      background: var(--table-bg);
      border-radius: 12px;
      padding: 24px 28px;
      margin: 2rem 0 3rem;
      box-shadow: 0 0 14px var(--primary-color);
      display: flex;
      flex-direction: column;
      gap: 1rem;
      user-select: none;
    }

    input[type="file"] {
      padding: 12px;
      border-radius: 8px;
      border: 1.8px solid var(--input-border);
      background: var(--input-bg);
      color: var(--text-color);
      font-weight: 600;
      cursor: pointer;
    }
    input[type="file"]:hover { border-color: var(--primary-color); }

    label { font-weight: 600; color: var(--secondary-color); margin-right: 6px; }

    input[type="date"], select {
      padding: 8px 14px;
      border-radius: 8px;
      border: 1.5px solid var(--input-border);
      background: var(--input-bg);
      color: var(--text-color);
      font-weight: 600;
      max-width: 180px;
    }
    input[type="date"]:hover, select:hover { border-color: var(--primary-color); }

    button {
      background: var(--button-bg);
      border: none;
      border-radius: 8px;
      color: var(--button-text);
      font-weight: 700;
      padding: 10px 20px;
      cursor: pointer;
      max-width: 200px;
      user-select: none;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    button:hover { background: var(--primary-color); }

    #output {
      white-space: pre-line;
      background: var(--input-bg);
      padding: 14px 18px;
      border-radius: 8px;
      box-shadow: inset 0 0 10px var(--primary-color);
      min-height: 90px;
      font-weight: 600;
      font-size: 1rem;
      color: var(--text-color);
      overflow-x: auto;
    }

    #totalProfitDisplay {
      font-weight: 700;
      font-size: 1.15rem;
      text-align: center;
      margin-top: 0.8rem;
      color: var(--primary-color);
    }

    #periodSummary {
      margin-top: 1rem;
      font-weight: 600;
      white-space: pre-line;
      color: var(--text-color);
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      margin-top: 12px;
    }

    @media (max-width: 480px) {
      header h2 { font-size: 1.4rem; text-align: center; }
      main { padding: 18px 20px; }
      input[type="file"], select, input[type="date"], button {
        max-width: 100%;
        font-size: 0.9rem;
      }
    }
  </style>
</head>
<body>
  <header>
    <h2>P2P Profit Binance</h2>
    <button class="theme-toggle-btn">üåô –¢—ë–º–Ω–∞—è —Ç–µ–º–∞</button>
  </header>

  <main>
    <input type="file" id="fileInput" accept=".csv" />
    
    <div class="controls">
      <label for="dateFromInput">–°:</label>
      <input type="date" id="dateFromInput" />

      <label for="dateToInput">–ü–æ:</label>
      <input type="date" id="dateToInput" />

      <button id="resetBtn">–°–±—Ä–æ—Å–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
    </div>

    <pre id="output">–ó–∞–≥—Ä—É–∑–∏—Ç–µ CSV-—Ñ–∞–π–ª –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.</pre>

    <div id="totalProfitDisplay">–û–±—â–∞—è –ø—Ä–∏–±—ã–ª—å: 0 –≥—Ä–Ω</div>

    <pre id="periodSummary">–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.</pre>
  </main>

  <script>
    const body = document.body;
    const themeToggleBtn = document.querySelector('.theme-toggle-btn');
    const fileInput = document.getElementById('fileInput');
    const dateFromInput = document.getElementById('dateFromInput');
    const dateToInput = document.getElementById('dateToInput');
    const output = document.getElementById('output');
    const periodSummary = document.getElementById('periodSummary');
    const totalProfitDisplay = document.getElementById('totalProfitDisplay');
    const resetBtn = document.getElementById('resetBtn');

    let trades = [];

    // –¢–µ–º–∞
    function initTheme() {
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme === 'dark') {
        body.classList.add('dark');
        themeToggleBtn.textContent = '‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞';
      } else {
        body.classList.remove('dark');
        themeToggleBtn.textContent = 'üåô –¢—ë–º–Ω–∞—è —Ç–µ–º–∞';
      }
    }

    themeToggleBtn.addEventListener('click', () => {
      if (body.classList.contains('dark')) {
        body.classList.remove('dark');
        themeToggleBtn.textContent = 'üåô –¢—ë–º–Ω–∞—è —Ç–µ–º–∞';
        localStorage.setItem('theme', 'light');
      } else {
        body.classList.add('dark');
        themeToggleBtn.textContent = '‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞';
        localStorage.setItem('theme', 'dark');
      }
    });

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞
    fileInput.addEventListener('change', handleFile);

    function handleFile(e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (event) => {
        const text = event.target.result;
        processCSV(text);
        fileInput.style.display = 'none';
      };
      reader.readAsText(file);
    }

    // –ü–∞—Ä—Å–∏–Ω–≥ CSV
    function processCSV(csvText) {
      const rows = csvText.trim().split(/\r?\n/).map(r => r.split(','));
      const header = rows[0].map(h => h.trim());
      const data = rows.slice(1).filter(r => r.length === header.length);

      const orderTypeIdx = header.indexOf('Order Type');
      const priceIdx = header.indexOf('Price');
      const quantityIdx = header.indexOf('Quantity');
      let dateIdx = header.indexOf('Match time(UTC)');
      if (dateIdx === -1) dateIdx = header.indexOf('Created Time');
      const statusIdx = header.indexOf('Status');
      const feeIdx = header.indexOf('Maker Fee');

      if ([orderTypeIdx, priceIdx, quantityIdx, dateIdx, statusIdx, feeIdx].some(i => i === -1)) {
        output.textContent = '–û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –≤ CSV.';
        return;
      }

      trades = [];

      for (const row of data) {
        if (row[statusIdx].trim() !== 'Completed') continue;
        trades.push({
          type: row[orderTypeIdx].trim(),
          price: parseFloat(row[priceIdx]),
          qty: parseFloat(row[quantityIdx]),
          date: row[dateIdx].trim().substring(0, 10),
          fee: parseFloat(row[feeIdx] || 0) // –∫–æ–º–∏—Å—Å–∏—è –≤ $
        });
      }

      localStorage.setItem('trades', JSON.stringify(trades));
      output.textContent = '–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω.';
      initDatesFromData();
      updateFilteredView();
    }

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≥—Ä–∞–Ω–∏—Ü—ã –¥–∞—Ç
    function initDatesFromData() {
      const dates = trades.map(t => t.date).sort();
      if (dates.length > 0) {
        dateFromInput.value = dates[0];
        dateToInput.value = dates[dates.length - 1];
      } else {
        dateFromInput.value = '';
        dateToInput.value = '';
      }
    }

    // –ü–æ–¥—Å—á—ë—Ç –ø—Ä–∏–±—ã–ª–∏ —Å —É—á—ë—Ç–æ–º –∫–æ–º–∏—Å—Å–∏–∏
    function updateFilteredView() {
      periodSummary.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';

      const from = dateFromInput.value || '0000-00-00';
      const to = dateToInput.value || '9999-99-99';

      const filtered = trades.filter(t => t.date >= from && t.date <= to);

      let buyQty = 0, buyUah = 0;
      let sellQty = 0, sellUah = 0;
      let totalFeeUSD = 0;

      filtered.forEach(t => {
        if (t.type === 'Buy') {
          buyQty += t.qty;
          buyUah += t.qty * t.price;
        } else if (t.type === 'Sell') {
          sellQty += t.qty;
          sellUah += t.qty * t.price;
        }

        if (t.fee) totalFeeUSD += parseFloat(t.fee);
      });

      const avgBuy = buyQty ? buyUah / buyQty : 0;
      const avgSell = sellQty ? sellUah / sellQty : 0;
      const circle = Math.min(buyQty, sellQty);
      const grossProfit = circle * (avgSell - avgBuy);

      // –°—Ä–µ–¥–Ω–∏–π –∫—É—Ä—Å –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞ –∫–æ–º–∏—Å—Å–∏–∏ –≤ –≥—Ä–Ω
      const avgRate = (avgBuy + avgSell) / 2;
      const feeUah = totalFeeUSD * avgRate;

      const netProfit = grossProfit - feeUah;

      const periodText =
        `–ö—É–ø–ª–µ–Ω–æ USDT: ${buyQty.toFixed(2)}\n` +
        `–ü—Ä–æ–¥–∞–Ω–æ USDT: ${sellQty.toFixed(2)}\n` +
        `–°—Ä–µ–¥–Ω–∏–π –∫—É—Ä—Å –ø–æ–∫—É–ø–∫–∏: ${avgBuy.toFixed(2)} –≥—Ä–Ω\n` +
        `–°—Ä–µ–¥–Ω–∏–π –∫—É—Ä—Å –ø—Ä–æ–¥–∞–∂–∏: ${avgSell.toFixed(2)} –≥—Ä–Ω\n` +
        `–û–±—ä—ë–º –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –∫—Ä—É–≥–∞: ${circle.toFixed(2)} USDT\n` +
        `–ö–æ–º–∏—Å—Å–∏—è: ${feeUah.toFixed(2)} –≥—Ä–Ω\n` +
        `–ü—Ä–∏–±—ã–ª—å –∑–∞ –ø–µ—Ä–∏–æ–¥: ${netProfit.toFixed(2)} –≥—Ä–Ω`;

      periodSummary.textContent = periodText;
      totalProfitDisplay.textContent = `–û–±—â–∞—è –ø—Ä–∏–±—ã–ª—å: ${netProfit.toFixed(2)} –≥—Ä–Ω`;

      output.textContent = `–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –í—ã–±—Ä–∞–Ω –ø–µ—Ä–∏–æ–¥ —Å ${from} –ø–æ ${to}.`;
    }

    // –°–±—Ä–æ—Å
    resetBtn.addEventListener('click', () => {
      if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –≤—Å—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É?')) {
        trades = [];
        localStorage.removeItem('trades');
        periodSummary.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.';
        totalProfitDisplay.textContent = '–û–±—â–∞—è –ø—Ä–∏–±—ã–ª—å: 0 –≥—Ä–Ω';
        output.textContent = '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–±—Ä–æ—à–µ–Ω–∞. –ó–∞–≥—Ä—É–∑–∏—Ç–µ CSV-—Ñ–∞–π–ª –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.';
        dateFromInput.value = '';
        dateToInput.value = '';
        fileInput.value = '';
        fileInput.style.display = 'block';
      }
    });

    dateFromInput.addEventListener('change', updateFilteredView);
    dateToInput.addEventListener('change', updateFilteredView);

    window.addEventListener('load', () => {
      initTheme();
      const saved = localStorage.getItem('trades');
      if (saved) {
        trades = JSON.parse(saved);
        fileInput.style.display = 'none';
        initDatesFromData();
        updateFilteredView();
      }
    });
  </script>
</body>
</html>