<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>P2P Profit Binance</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap');
    body {
      margin: 0; padding: 0; font-family: 'Montserrat', sans-serif;
      background: #121315;
      color: #d6b900;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin: 1.5rem 0;
      flex-wrap: wrap;
    }
    header svg {
      display: block;
      flex-shrink: 0;
    }
    header h2 {
      font-weight: 700;
      font-size: 1.8rem;
      margin: 0;
      text-shadow: 0 0 6px #d6b900cc;
    }

    main {
      width: 95%;
      max-width: 720px;
      background: #1e1f22;
      border-radius: 12px;
      padding: 20px 25px;
      box-shadow: 0 0 12px #d6b900aa;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      user-select: none;
    }

    input[type="file"] {
      padding: 10px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      background: #2a2b2f;
      color: #d6b900;
      font-weight: 600;
      transition: background 0.3s;
    }
    input[type="file"]:hover {
      background: #3e3f43;
    }

    label {
      display: block;
      margin-bottom: 4px;
      font-weight: 600;
      color: #f0d830;
    }
    select, input[type="date"] {
      padding: 8px 12px;
      border-radius: 6px;
      border: none;
      background: #2a2b2f;
      color: #d6b900;
      font-weight: 600;
      transition: background 0.3s;
      max-width: 200px;
      cursor: pointer;
    }
    select:hover, input[type="date"]:hover {
      background: #3e3f43;
    }

    button {
      background: #d6b900;
      border: none;
      border-radius: 8px;
      color: #121315;
      font-weight: 700;
      padding: 10px 20px;
      cursor: pointer;
      transition: background 0.3s;
      user-select: none;
      max-width: 200px;
      margin-top: 8px;
      align-self: flex-start;
    }
    button:hover {
      background: #f0db30;
    }

    #output {
      white-space: pre-line;
      background: #121315;
      padding: 12px 15px;
      border-radius: 8px;
      box-shadow: inset 0 0 8px #d6b900cc;
      min-height: 90px;
      font-weight: 600;
      font-size: 1rem;
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: #2a2b2f;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 0 10px #d6b90099;
    }
    th, td {
      padding: 10px 8px;
      text-align: center;
      font-weight: 600;
      color: #f9f8f0;
      border-bottom: 1px solid #444548;
    }
    th {
      background: #3e3f43;
      color: #d6b900;
      text-transform: uppercase;
      font-size: 0.85rem;
    }
    tbody tr:last-child td {
      border-bottom: none;
    }

    /* Responsive */
    @media (max-width: 480px) {
      header h2 {
        font-size: 1.4rem;
        text-align: center;
      }
      main {
        padding: 15px 15px;
      }
      table, th, td {
        font-size: 0.8rem;
      }
      input[type="file"], select, input[type="date"], button {
        max-width: 100%;
        font-size: 0.9rem;
      }
    }
  </style>
</head>
<body>
  <header>
    <svg width="40" height="40" viewBox="0 0 256 256" fill="none" xmlns="http://www.w3.org/2000/svg" aria-label="Binance Logo" role="img">
      <path fill="#F3BA2F" d="M128 0L256 128L128 256L0 128L128 0Z"/>
      <path fill="#121315" d="M128 45.333L171.2 88.533L128 131.733L84.8 88.533L128 45.333Z"/>
      <path fill="#121315" d="M128 124.267L163.733 159L128 193.733L92.267 159L128 124.267Z"/>
    </svg>
    <h2>P2P Profit Binance</h2>
  </header>

  <main>
    <input type="file" id="fileInput" accept=".csv" />
    
    <div style="display:flex; flex-wrap: wrap; gap: 12px; align-items: center; margin-top: 12px;">
      <label for="dateFromInput">С:</label>
      <input type="date" id="dateFromInput" />
      
      <label for="dateToInput">По:</label>
      <input type="date" id="dateToInput" />
      
      <button id="resetBtn" style="margin-left:auto;">Сбросить статистику</button>
    </div>
    
    <pre id="output">Загрузите CSV-файл для анализа.</pre>
    
    <div id="totalProfitDisplay" style="font-weight:700; font-size:1.1rem; margin-top: 0.8rem; text-align:center;">
      Общая прибыль: 0 грн
    </div>

    <div style="margin-top: 20px; overflow-x:auto;">
      <table id="dailyTable" aria-label="Статистика по дням">
        <thead>
          <tr><th>Дата</th><th>Прибыль (грн)</th></tr>
        </thead>
        <tbody>
          <!-- Данные по дням появятся здесь -->
        </tbody>
      </table>
    </div>

    <pre id="periodSummary" style="margin-top: 1rem; font-weight:600; white-space: pre-line;">
Выберите период для просмотра статистики.
    </pre>
  </main>

  <script>
    const fileInput = document.getElementById("fileInput");
    const dateFromInput = document.getElementById("dateFromInput");
    const dateToInput = document.getElementById("dateToInput");
    const output = document.getElementById("output");
    const dailyTableBody = document.querySelector("#dailyTable tbody");
    const periodSummary = document.getElementById("periodSummary");
    const totalProfitDisplay = document.getElementById("totalProfitDisplay");
    const resetBtn = document.getElementById("resetBtn");

    let dailyProfit = {};

    fileInput.addEventListener("change", handleFile);
    dateFromInput.addEventListener("change", updateFilteredView);
    dateToInput.addEventListener("change", updateFilteredView);
    resetBtn.addEventListener("click", resetStats);

    function handleFile(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        const text = e.target.result;
        processCSV(text);
      };
      reader.readAsText(file);
    }

    function processCSV(csvText) {
      const rows = csvText.trim().split(/\r?\n/).map(r => r.split(','));
      const header = rows[0].map(h => h.trim());
      const data = rows.slice(1).filter(r => r.length === header.length);

      // Определяем индекс нужных колонок, с учётом вариаций
      const orderTypeIdx = header.indexOf("Order Type");
      const priceIdx = header.indexOf("Price");
      const quantityIdx = header.indexOf("Quantity");
      let dateIdx = header.indexOf("Match time(UTC)");
      if (dateIdx === -1) dateIdx = header.indexOf("Created Time");
      const statusIdx = header.indexOf("Status");

      if ([orderTypeIdx, priceIdx, quantityIdx, dateIdx, statusIdx].some(i => i === -1)) {
        output.textContent = "Ошибка: не найдены необходимые колонки в CSV.";
        return;
      }

      // Обрабатываем и аккумулируем по дням
      for (const row of data) {
        if (row[statusIdx].trim() !== "Completed") continue;

        const type = row[orderTypeIdx].trim();
        const price = parseFloat(row[priceIdx]);
        const qty = parseFloat(row[quantityIdx]);
        let dateStr = row[dateIdx].trim();

        // Обработка даты: отрезаем время, оставляем только дату в формате YYYY-MM-DD
        if (dateStr.length > 10) dateStr = dateStr.substring(0, 10);

        if (!dailyProfit[dateStr]) {
          dailyProfit[dateStr] = {
            buyUah: 0,
            buyQty: 0,
            sellUah: 0,
            sellQty: 0,
          };
        }

        if (type === "Buy") {
          dailyProfit[dateStr].buyQty += qty;
          dailyProfit[dateStr].buyUah += qty * price;
        } else if (type === "Sell") {
          dailyProfit[dateStr].sellQty += qty;
          dailyProfit[dateStr].sellUah += qty * price;
        }
      }

      // Сохраняем в localStorage
      localStorage.setItem("dailyProfit", JSON.stringify(dailyProfit));
      output.textContent = "Файл успешно обработан.";
      updateFilteredView();
    }

    function updateFilteredView() {
      dailyTableBody.innerHTML = "";
      periodSummary.textContent = "Загрузка...";
      
      const from = dateFromInput.value || "0000-00-00";
      const to = dateToInput.value || "9999-99-99";

      const filteredDates = Object.keys(dailyProfit)
        .filter(d => d >= from && d <= to)
        .sort();

      let totalBuyUah = 0, totalBuyQty = 0, totalSellUah = 0, totalSellQty = 0;
      let totalProfit = 0;

      filteredDates.forEach(date => {
        const day = dailyProfit[date];
        const avgBuyRate = day.buyQty ? day.buyUah / day.buyQty : 0;
        const avgSellRate = day.sellQty ? day.sellUah / day.sellQty : 0;
        const circleQty = Math.min(day.buyQty, day.sellQty);
        const profit = circleQty * (avgSellRate - avgBuyRate);

        totalBuyUah += day.buyUah;
        totalBuyQty += day.buyQty;
        totalSellUah += day.sellUah;
        totalSellQty += day.sellQty;
        totalProfit += profit;

        const tr = document.createElement("tr");
        const tdDate = document.createElement("td");
        tdDate.textContent = date;
        const tdProfit = document.createElement("td");
        tdProfit.textContent = profit.toFixed(2);
        tr.appendChild(tdDate);
        tr.appendChild(tdProfit);
        dailyTableBody.appendChild(tr);
      });

      const avgBuyRateTotal = totalBuyQty ? totalBuyUah / totalBuyQty : 0;
      const avgSellRateTotal = totalSellQty ? totalSellUah / totalSellQty : 0;
      const circleTotal = Math.min(totalBuyQty, totalSellQty);

      const periodText = 
        `Куплено USDT: ${totalBuyQty.toFixed(2)}\n` +
        `Продано USDT: ${totalSellQty.toFixed(2)}\n` +
        `Средний курс покупки: ${avgBuyRateTotal.toFixed(2)} грн\n` +
        `Средний курс продажи: ${avgSellRateTotal.toFixed(2)} грн\n` +
        `Объём для полного круга: ${circleTotal.toFixed(2)} USDT\n` +
        `Прибыль за период: ${totalProfit.toFixed(2)} грн`;

      periodSummary.textContent = periodText;
      totalProfitDisplay.textContent = `Общая прибыль: ${totalProfit.toFixed(2)} грн`;

      output.textContent = `Обработка завершена. Выбран период с ${from} по ${to}.`;
    }

    function resetStats() {
      if (confirm("Вы уверены, что хотите сбросить всю статистику?")) {
        dailyProfit = {};
        localStorage.removeItem("dailyProfit");
        dailyTableBody.innerHTML = "";
        periodSummary.textContent = "Выберите период для просмотра статистики.";
        totalProfitDisplay.textContent = "Общая прибыль: 0 грн";
        output.textContent = "Статистика сброшена. Загрузите CSV-файл.";
        dateFromInput.value = "";
        dateToInput.value = "";
        fileInput.value = "";
      }
    }

    // Загрузка данных из localStorage при загрузке страницы (если есть)
    window.addEventListener('load', () => {
      const saved = localStorage.getItem("dailyProfit");
      if (saved) {
        dailyProfit = JSON.parse(saved);
        const dates = Object.keys(dailyProfit).sort();
        if (dates.length > 0) {
          dateFromInput.value = dates[0];
          dateToInput.value = dates[dates.length - 1];
          updateFilteredView();
        }
      }
    });
  </script>
</body>
</html>
