<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>P2P Profit Binance</title>
  <style>
    :root {
      --bg-color: #f5f7fa;
      --text-color: #222;
      --primary-color: #1a73e8;
      --secondary-color: #555;
      --accent-color: #e8f0fe;
      --button-bg: #1a73e8;
      --button-text: #fff;
      --input-bg: #fff;
      --input-border: #ccc;
      --table-bg: #fff;
      --table-header-bg: #eaeaea;
      --table-border: #ddd;
    }

    body.dark {
      --bg-color: #121315;
      --text-color: #d6b900;
      --primary-color: #f3ba2f;
      --secondary-color: #ccc;
      --accent-color: #2a2b2f;
      --button-bg: #d6b900;
      --button-text: #121315;
      --input-bg: #1e1f22;
      --input-border: #444548;
      --table-bg: #2a2b2f;
      --table-header-bg: #3e3f43;
      --table-border: #444548;
    }

    /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ */
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      transition: background-color 0.4s, color 0.4s;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    header {
      width: 100%;
      max-width: 720px;
      padding: 1.2rem 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--accent-color);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border-radius: 0 0 12px 12px;
      transition: background 0.4s;
    }

    header h2 {
      margin: 0;
      font-weight: 700;
      font-size: 1.8rem;
      color: var(--primary-color);
      user-select: none;
    }

    .theme-toggle-btn {
      background: var(--button-bg);
      border: none;
      padding: 8px 14px;
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
      color: var(--button-text);
      transition: background-color 0.3s;
      user-select: none;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    .theme-toggle-btn:hover {
      background: var(--primary-color);
      color: var(--button-text);
    }

    main {
      width: 95%;
      max-width: 720px;
      background: var(--table-bg);
      border-radius: 12px;
      padding: 24px 28px;
      margin: 2rem 0 3rem;
      box-shadow: 0 0 14px var(--primary-color);
      display: flex;
      flex-direction: column;
      gap: 1rem;
      user-select: none;
      transition: background-color 0.4s;
    }

    input[type="file"] {
      padding: 12px;
      border-radius: 8px;
      border: 1.8px solid var(--input-border);
      background: var(--input-bg);
      color: var(--text-color);
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s, border-color 0.3s;
      user-select: none;
    }
    input[type="file"]:hover {
      border-color: var(--primary-color);
    }

    label {
      font-weight: 600;
      color: var(--secondary-color);
      margin-right: 6px;
      user-select: none;
    }

    input[type="date"], select {
      padding: 8px 14px;
      border-radius: 8px;
      border: 1.5px solid var(--input-border);
      background: var(--input-bg);
      color: var(--text-color);
      font-weight: 600;
      cursor: pointer;
      transition: border-color 0.3s;
      max-width: 180px;
    }
    input[type="date"]:hover, select:hover {
      border-color: var(--primary-color);
    }

    button {
      background: var(--button-bg);
      border: none;
      border-radius: 8px;
      color: var(--button-text);
      font-weight: 700;
      padding: 10px 20px;
      cursor: pointer;
      transition: background-color 0.3s;
      max-width: 200px;
      user-select: none;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    button:hover {
      background: var(--primary-color);
    }

    #output {
      white-space: pre-line;
      background: var(--input-bg);
      padding: 14px 18px;
      border-radius: 8px;
      box-shadow: inset 0 0 10px var(--primary-color);
      min-height: 90px;
      font-weight: 600;
      font-size: 1rem;
      color: var(--text-color);
      overflow-x: auto;
      transition: background-color 0.4s, color 0.4s;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: var(--table-bg);
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 0 12px var(--primary-color);
      transition: background-color 0.4s;
    }
    th, td {
      padding: 12px 10px;
      text-align: center;
      font-weight: 600;
      color: var(--text-color);
      border-bottom: 1px solid var(--table-border);
      user-select: none;
    }
    th {
      background: var(--table-header-bg);
      color: var(--primary-color);
      text-transform: uppercase;
      font-size: 0.85rem;
    }
    tbody tr:last-child td {
      border-bottom: none;
    }

    #totalProfitDisplay {
      font-weight: 700;
      font-size: 1.15rem;
      text-align: center;
      margin-top: 0.8rem;
      color: var(--primary-color);
      user-select: none;
    }

    #periodSummary {
      margin-top: 1rem;
      font-weight: 600;
      white-space: pre-line;
      color: var(--text-color);
      user-select: none;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      margin-top: 12px;
    }

    /* Responsive */
    @media (max-width: 480px) {
      header h2 {
        font-size: 1.4rem;
        text-align: center;
      }
      main {
        padding: 18px 20px;
      }
      table, th, td {
        font-size: 0.85rem;
      }
      input[type="file"], select, input[type="date"], button {
        max-width: 100%;
        font-size: 0.9rem;
      }
    }
  </style>
</head>
<body>
  <header>
    <h2>P2P Profit Binance</h2>
    <button class="theme-toggle-btn" aria-label="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">üåô –¢—ë–º–Ω–∞—è —Ç–µ–º–∞</button>
  </header>

  <main>
    <input type="file" id="fileInput" accept=".csv" aria-label="–ó–∞–≥—Ä—É–∑–∏—Ç—å CSV —Ñ–∞–π–ª" />
    
    <div class="controls">
      <label for="dateFromInput">–°:</label>
      <input type="date" id="dateFromInput" aria-label="–î–∞—Ç–∞ —Å" />

      <label for="dateToInput">–ü–æ:</label>
      <input type="date" id="dateToInput" aria-label="–î–∞—Ç–∞ –ø–æ" />

      <button id="resetBtn">–°–±—Ä–æ—Å–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
    </div>

    <pre id="output">–ó–∞–≥—Ä—É–∑–∏—Ç–µ CSV-—Ñ–∞–π–ª –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.</pre>

    <div id="totalProfitDisplay">–û–±—â–∞—è –ø—Ä–∏–±—ã–ª—å: 0 –≥—Ä–Ω</div>

    <div style="margin-top: 20px; overflow-x:auto;">
      <table id="dailyTable" aria-label="–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –¥–Ω—è–º">
        <thead>
          <tr><th>–î–∞—Ç–∞</th><th>–ü—Ä–∏–±—ã–ª—å (–≥—Ä–Ω)</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <pre id="periodSummary">–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.</pre>
  </main>

  <script>
    const body = document.body;
    const themeToggleBtn = document.querySelector('.theme-toggle-btn');
    const fileInput = document.getElementById('fileInput');
    const dateFromInput = document.getElementById('dateFromInput');
    const dateToInput = document.getElementById('dateToInput');
    const output = document.getElementById('output');
    const dailyTableBody = document.querySelector('#dailyTable tbody');
    const periodSummary = document.getElementById('periodSummary');
    const totalProfitDisplay = document.getElementById('totalProfitDisplay');
    const resetBtn = document.getElementById('resetBtn');

    let dailyProfit = {};

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–º—ã –∏–∑ localStorage –∏–ª–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–≤–µ—Ç–ª–∞—è
    function initTheme() {
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme === 'dark') {
        body.classList.add('dark');
        themeToggleBtn.textContent = '‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞';
      } else {
        body.classList.remove('dark');
        themeToggleBtn.textContent = 'üåô –¢—ë–º–Ω–∞—è —Ç–µ–º–∞';
      }
    }

    themeToggleBtn.addEventListener('click', () => {
      if (body.classList.contains('dark')) {
        body.classList.remove('dark');
        themeToggleBtn.textContent = 'üåô –¢—ë–º–Ω–∞—è —Ç–µ–º–∞';
        localStorage.setItem('theme', 'light');
      } else {
        body.classList.add('dark');
        themeToggleBtn.textContent = '‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞';
        localStorage.setItem('theme', 'dark');
      }
    });

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ CSV —Ñ–∞–π–ª–∞
    fileInput.addEventListener('change', handleFile);

    function handleFile(e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (event) => {
        const text = event.target.result;
        processCSV(text);
        // –°–∫—Ä—ã–≤–∞–µ–º input –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞
        fileInput.style.display = 'none';
      };
      reader.readAsText(file);
    }

    // –ü–∞—Ä—Å–∏–º CSV, —Å—á–∏—Ç–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –¥–Ω—è–º
    function processCSV(csvText) {
      const rows = csvText.trim().split(/\r?\n/).map(row => row.split(','));
      const header = rows[0].map(h => h.trim());
      const data = rows.slice(1).filter(r => r.length === header.length);

      // –ò–Ω–¥–µ–∫—Å—ã –Ω—É–∂–Ω—ã—Ö –∫–æ–ª–æ–Ω–æ–∫
      const orderTypeIdx = header.indexOf('Order Type');
      const priceIdx = header.indexOf('Price');
      const quantityIdx = header.indexOf('Quantity');
      let dateIdx = header.indexOf('Match time(UTC)');
      if (dateIdx === -1) dateIdx = header.indexOf('Created Time');
      const statusIdx = header.indexOf('Status');

      if ([orderTypeIdx, priceIdx, quantityIdx, dateIdx, statusIdx].some(i => i === -1)) {
        output.textContent = '–û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –≤ CSV.';
        return;
      }

      dailyProfit = {}; // –æ—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ

      for (const row of data) {
        if (row[statusIdx].trim() !== 'Completed') continue;

        const type = row[orderTypeIdx].trim();
        const price = parseFloat(row[priceIdx]);
        const qty = parseFloat(row[quantityIdx]);
        let dateStr = row[dateIdx].trim();

        if (dateStr.length > 10) dateStr = dateStr.substring(0, 10);

        if (!dailyProfit[dateStr]) {
          dailyProfit[dateStr] = { buyUah: 0, buyQty: 0, sellUah: 0, sellQty: 0 };
        }

        if (type === 'Buy') {
          dailyProfit[dateStr].buyQty += qty;
          dailyProfit[dateStr].buyUah += qty * price;
        } else if (type === 'Sell') {
          dailyProfit[dateStr].sellQty += qty;
          dailyProfit[dateStr].sellUah += qty * price;
        }
      }

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
      localStorage.setItem('dailyProfit', JSON.stringify(dailyProfit));
      output.textContent = '–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω.';
      initDatesFromData();
      updateFilteredView();
    }

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞—Ç—ã –≤—ã–±–æ—Ä–∞ –Ω–∞ –ø–µ—Ä–≤—ã–π –∏ –ø–æ—Å–ª–µ–¥–Ω–∏–π –¥–µ–Ω—å –∏–∑ –¥–∞–Ω–Ω—ã—Ö
    function initDatesFromData() {
      const dates = Object.keys(dailyProfit).sort();
      if (dates.length > 0) {
        dateFromInput.value = dates[0];
        dateToInput.value = dates[dates.length - 1];
      } else {
        dateFromInput.value = '';
        dateToInput.value = '';
      }
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –ø–µ—Ä–∏–æ–¥—É
    function updateFilteredView() {
      dailyTableBody.innerHTML = '';
      periodSummary.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';

      const from = dateFromInput.value || '0000-00-00';
      const to = dateToInput.value || '9999-99-99';

      const filteredDates = Object.keys(dailyProfit)
        .filter(d => d >= from && d <= to)
        .sort();

      let totalBuyUah = 0, totalBuyQty = 0, totalSellUah = 0, totalSellQty = 0;
      let totalProfit = 0;

      filteredDates.forEach(date => {
        const day = dailyProfit[date];
        const avgBuyRate = day.buyQty ? day.buyUah / day.buyQty : 0;
        const avgSellRate = day.sellQty ? day.sellUah / day.sellQty : 0;
        const circleQty = Math.min(day.buyQty, day.sellQty);
        const profit = circleQty * (avgSellRate - avgBuyRate);

        totalBuyUah += day.buyUah;
        totalBuyQty += day.buyQty;
        totalSellUah += day.sellUah;
        totalSellQty += day.sellQty;
        totalProfit += profit;

        const tr = document.createElement('tr');
        const tdDate = document.createElement('td');
        tdDate.textContent = date;
        const tdProfit = document.createElement('td');
        tdProfit.textContent = profit.toFixed(2);
        tr.appendChild(tdDate);
        tr.appendChild(tdProfit);
        dailyTableBody.appendChild(tr);
      });

      const avgBuyRateTotal = totalBuyQty ? totalBuyUah / totalBuyQty : 0;
      const avgSellRateTotal = totalSellQty ? totalSellUah / totalSellQty : 0;
      const circleTotal = Math.min(totalBuyQty, totalSellQty);

      const periodText = 
        `–ö—É–ø–ª–µ–Ω–æ USDT: ${totalBuyQty.toFixed(2)}\n` +
        `–ü—Ä–æ–¥–∞–Ω–æ USDT: ${totalSellQty.toFixed(2)}\n` +
        `–°—Ä–µ–¥–Ω–∏–π –∫—É—Ä—Å –ø–æ–∫—É–ø–∫–∏: ${avgBuyRateTotal.toFixed(2)} –≥—Ä–Ω\n` +
        `–°—Ä–µ–¥–Ω–∏–π –∫—É—Ä—Å –ø—Ä–æ–¥–∞–∂–∏: ${avgSellRateTotal.toFixed(2)} –≥—Ä–Ω\n` +
        `–û–±—ä—ë–º –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –∫—Ä—É–≥–∞: ${circleTotal.toFixed(2)} USDT\n` +
        `–ü—Ä–∏–±—ã–ª—å –∑–∞ –ø–µ—Ä–∏–æ–¥: ${totalProfit.toFixed(2)} –≥—Ä–Ω`;

      periodSummary.textContent = periodText;
      totalProfitDisplay.textContent = `–û–±—â–∞—è –ø—Ä–∏–±—ã–ª—å: ${totalProfit.toFixed(2)} –≥—Ä–Ω`;

      output.textContent = `–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –í—ã–±—Ä–∞–Ω –ø–µ—Ä–∏–æ–¥ —Å ${from} –ø–æ ${to}.`;
    }

    // –°–±—Ä–æ—Å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    resetBtn.addEventListener('click', () => {
      if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –≤—Å—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É?')) {
        dailyProfit = {};
        localStorage.removeItem('dailyProfit');
        dailyTableBody.innerHTML = '';
        periodSummary.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.';
        totalProfitDisplay.textContent = '–û–±—â–∞—è –ø—Ä–∏–±—ã–ª—å: 0 –≥—Ä–Ω';
        output.textContent = '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–±—Ä–æ—à–µ–Ω–∞. –ó–∞–≥—Ä—É–∑–∏—Ç–µ CSV-—Ñ–∞–π–ª –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.';
        dateFromInput.value = '';
        dateToInput.value = '';
        fileInput.value = '';
        fileInput.style.display = 'block'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º input –∑–∞–Ω–æ–≤–æ
      }
    });

    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –¥–∞—Ç
    dateFromInput.addEventListener('change', updateFilteredView);
    dateToInput.addEventListener('change', updateFilteredView);

    // –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏ –µ—Å–ª–∏ –µ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ ‚Äî –∑–∞–≥—Ä—É–∂–∞–µ–º –∏—Ö
    window.addEventListener('load', () => {
      initTheme();

      const savedProfit = localStorage.getItem('dailyProfit');
      if (savedProfit) {
        dailyProfit = JSON.parse(savedProfit);
        fileInput.style.display = 'none';
        initDatesFromData();
        updateFilteredView();
      }
    });
  </script>
</body>
</html>
